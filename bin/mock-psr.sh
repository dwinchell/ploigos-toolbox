#!/bin/bash
STEP=$1

unit-test() {
  echo "####################################################################################################"
  echo "############################     RUNNING UNIT TESTS     ############################################"
  echo "####################################################################################################"
  echo
  if [ -f "pom.xml" ]; then
    echo "####################################################################################################"
    echo "############################     USING MAVEN     ###################################################"
    echo "####################################################################################################"
    echo
    echo "Detected pom.xml. Using Maven. You can configure PSR to change this."
    mvn test
    RESULT=$?
  elif [ -f "package.json" ]; then
    echo "####################################################################################################"
    echo "############################     USING NPM     #####################################################"
    echo "####################################################################################################"
    echo
    echo "Detected package.json. Using npm. You can configure PSR to change this."
    npm test
    RESULT=$?
  else
    echo "Error: no step implementer specified in configuration and could not auto-detect which one to use."
  fi
  echo "####################################################################################################"
  if [[ ${RESULT} == 0 ]]; then
  echo "############################     UNIT TESTS PASS     ###############################################"
  else
  echo "############################     UNIT TESTS FAIL     ###############################################"
  fi
  echo "####################################################################################################"
  echo
}

security() {
  echo
  echo "####################################################################################################"
  echo "############################     RUNNING VULNERABILITY SCAN     ####################################"
  echo "####################################################################################################"
  echo

  snyk test
    RESULT=$?

  echo "####################################################################################################"
  if [[ ${RESULT} == 0 ]]; then
  echo "############################     VULNERABILITY SCAN -  PASS     ####################################"
  else
  echo "############################     VULNERABILITY SCAN -  FAIL     ####################################"
  fi
  echo "####################################################################################################"
}

quality() {
  echo
  echo "####################################################################################################"
  echo "############################     RUNNING QUALITY SCAN     ##########################################"
  echo "####################################################################################################"
  echo

  if [ -f "pom.xml" ]; then
    echo "####################################################################################################"
    echo "############################     USING MAVEN     ###################################################"
    echo "####################################################################################################"
    echo
    echo "Detected pom.xml. Using Maven. You can configure PSR to change this."
    mvn checkstyle:check
    RESULT=$?
  elif [ -f "package.json" ]; then
    echo "####################################################################################################"
    echo "############################     USING NPM     #####################################################"
    echo "####################################################################################################"
    echo
    echo "Detected package.json. Using npm. You can configure PSR to change this."
    #cat package.json | jq .devDependencies.jslint | grep \"
    npx jslint .
    RESULT=$?
  else
    echo "Error: no step implementer specified in configuration and could not auto-detect which one to use."
  fi


  echo "####################################################################################################"
  if [[ ${RESULT} == 0 ]]; then
  echo "############################     QUALITY SCAN -  PASS     ##########################################"
  else
  echo "############################     QUALITY SCAN -  FAIL     ##########################################"
  fi
  echo "####################################################################################################"
}

watch() {
 OLD_HASHES=""
 while [[ true ]]
 do
   NEW_HASHES=$(find . -type f -exec md5sum {} \;)
   if [ "${OLD_HASHES}" != "${NEW_HASHES}" ]; then
     all
   fi
   OLD_HASHES=${NEW_HASHES}
   sleep 1
 done
}

all() {
  unit-test
  security
  quality
}

run() {
  if [ "${STEP}" == "unit-test" ]; then
    unit-test
  elif [ "${STEP}" == "security" ]; then
    security
  elif [ "${STEP}" == "quality" ]; then
    quality
  elif [ "${STEP}" == "all" ]; then
    all
  elif [ "${STEP}" == "watch" ]; then
    watch
  fi
}

run

